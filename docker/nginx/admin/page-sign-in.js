webpackJsonp(["page-sign-in"],{"./pages/sign-in-page.jsx":function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){switch(e){case"facebook":return"facebook-official";default:return e}}Object.defineProperty(t,"__esModule",{value:!0}),t.SignInPageSync=t.SignInPage=t.default=void 0;var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),c=n("../../common/node_modules/lodash/lodash.js"),d=a(c),f=n("../../common/node_modules/react/index.js"),m=a(f),p=n("../../common/node_modules/relaks/index.js"),h=n("../../common/node_modules/moment/moment.js"),v=a(h),b=n("../../common/src/transport/http-request.js"),g=(function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);t.default=e}(b),n("./widgets/push-button.jsx")),y=a(g),w=n("./widgets/text-field.jsx"),E=a(w);n("./pages/sign-in-page.scss");var j=n("../../common/src/data/database.js"),O=(a(j),n("../../common/src/routing/route.js")),S=(a(O),n("../../common/src/env/environment.js")),k=(a(S),function(e){function t(){return r(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),l(t,[{key:"renderAsync",value:function(e){var t=this.props,n=t.database,a=t.route,r=t.env,s=n.use({by:this}),o={system:void 0,servers:void 0,database:n,route:a,env:r};return e.show(m.default.createElement(P,o)),s.beginSession("admin").then(function(e){return o.system=e.system,o.servers=e.servers,m.default.createElement(P,o)})}}]),t}(p.AsyncComponent));k.displayName="SignInPage";var P=function(e){function t(e){r(this,t);var n=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.handleOAuthButtonClick=function(e){var t=n.props.database,a=(n.state.errors,e.currentTarget.getAttribute("href")),r=parseInt(e.currentTarget.getAttribute("data-id"));return e.preventDefault(),n.openPopUpWindow(a).then(function(){return t.use({by:n}).checkSession().catch(function(e){var t=d.default.clone(t);t[r]=e,n.setState({errors:t})})})},n.handleUsernameChange=function(e){var t=(0,v.default)(),a=e.target.value,r=!1;a.length>3&&t-n.mountTime<500&&(r=!0),n.setState({username:a,savedCredentials:r})},n.handlePasswordChange=function(e){var t=e.target.value;n.setState({password:t,savedCredentials:!1})},n.handleFormSubmit=function(e){var t=n.props.database,a=n.state,r=a.username,s=a.password;e.preventDefault(),n.canSubmitForm()&&n.setState({submitting:!0},function(){var e=t.use({by:n}),a={type:"password",username:r,password:s};e.authenticate(a).catch(function(e){var t=void 0;switch(e.statusCode){case 401:t="incorrect-username-password";break;case 403:t="no-support-for-username-password";break;default:t="unexpected-error"}n.setState({problem:t,submitting:!1})})})},n.state={username:"",password:"",savedCredentials:!1,submitting:!1,problem:null,errors:{}},n}return o(t,e),l(t,[{key:"canSubmitForm",value:function(){var e=this.state,t=e.username,n=e.password;return!!d.default.trim(t)&&!!d.default.trim(n)}},{key:"render",value:function(){return m.default.createElement("div",{className:"sign-in-page"},this.renderForm(),this.renderOAuthButtons())}},{key:"renderForm",value:function(){var e=this.props,t=e.env,n=e.system,a=this.state,r=a.username,s=a.password,o=a.submitting,u=a.savedCredentials,i=t.locale,l=i.t,c=i.p,f=this.canSubmitForm(),p=c(d.default.get(n,"details.title")),h={id:"username",type:"text",value:r,disabled:o,env:t,onChange:this.handleUsernameChange},v={id:"password",type:"password",value:s,disabled:o,env:t,onChange:this.handlePasswordChange},b=!f;return u&&(b=!1),o&&(b=!0),m.default.createElement("section",null,m.default.createElement("h2",null,l("sign-in-$title",p)),m.default.createElement("form",{onSubmit:this.handleFormSubmit},this.renderProblem(),m.default.createElement(E.default,h,l("sign-in-username")),m.default.createElement(E.default,v,l("sign-in-password")),m.default.createElement("div",{className:"button-row"},m.default.createElement(y.default,{disabled:b},l("sign-in-submit")))))}},{key:"renderProblem",value:function(){var e=this.props.env,t=this.state.problem,n=e.locale.t;return t?m.default.createElement("div",{className:"error"},m.default.createElement("i",{className:"fa fa-exclamation-circle"})," ",n("sign-in-problem-"+t)):null}},{key:"renderOAuthButtons",value:function(){var e=this,t=this.props,n=t.env,a=t.servers,r=n.locale.t;return a=d.default.sortBy(a,["type"]),d.default.isEmpty(a)?null:m.default.createElement("section",null,m.default.createElement("h2",null,r("sign-in-oauth")),m.default.createElement("div",{className:"oauth-buttons"},d.default.map(a,function(t){return e.renderOAuthButton(t)})))}},{key:"renderOAuthButton",value:function(e){var t=this.props,n=t.database,a=t.env,r=this.state.errors,s=a.locale,o=s.t,l=s.p,c=l(e.details.title)||o("server-type-"+e.type),d=u(e.type),f=n.getOAuthURL(e),p={className:"oauth-button",href:f,onClick:this.handleOAuthButtonClick,"data-id":e.id},h=r[e.id];if(h){var v=o("sign-in-error-"+h.reason);return p.className+=" error",m.default.createElement("a",i({key:e.id},p),m.default.createElement("span",{className:"icon"},m.default.createElement("i",{className:"fa fa-fw fa-"+d})),m.default.createElement("span",{className:"error"},v))}return m.default.createElement("a",i({key:e.id},p),m.default.createElement("span",{className:"icon"},m.default.createElement("i",{className:"fa fa-fw fa-"+d})),m.default.createElement("span",{className:"label"},c))}},{key:"componentDidMount",value:function(){this.mountTime=(0,v.default)()}},{key:"openPopUpWindow",value:function(e){return new Promise(function(t,n){var a=window,r=a.screenLeft,s=a.screenTop,o=a.outerWidth,u=a.outerHeight,i={width:800,height:600,left:r+Math.round((o-800)/2),top:s+Math.round((u-600)/2),toolbar:"no",menubar:"no",status:"no"},l=d.default.map(i,function(e,t){return t+"="+e}),c=window.open(e,"sign-in",l.join(","));if(c){c.location=e;var f=setInterval(function(){c.closed&&(clearInterval(f),t())},50)}else n(new Error("Unable to open popup"))})}}]),t}(f.PureComponent);P.displayName="SignInPageSync",t.default=k,t.SignInPage=k,t.SignInPageSync=P},"./pages/sign-in-page.scss":function(e,t){}});