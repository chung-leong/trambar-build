webpackJsonp(["page-role-summary"],{"../../common/src/objects/finders/system-finder.js":function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function a(e){return e.findOne({schema:"global",table:"system",criteria:{},prefetch:!0}).then(function(e){return e||{}})}Object.defineProperty(t,"__esModule",{value:!0}),t.findSystem=void 0;var i=n("../../common/node_modules/lodash/lodash.js"),l=(r(i),n("../../common/node_modules/bluebird/js/browser/bluebird.js"));r(l);t.findSystem=a},"../../common/src/utils/slug-generator.js":function(e,t,n){"use strict";function r(e){"string"==typeof e&&(e={en:e});var t="";for(var n in e)if(t=String(e[n]),t=i(t).toLowerCase(),t=t.replace(/\s+/g,"-"),t=t.replace(/[^0-9a-z\-]/g,""),/^\-+$/.test(t)&&(t=""),t)break;return t.length>32&&(t=t.substr(0,32)),t}function a(e){"string"==typeof e&&(e={en:e});var t="";for(var n in e){var r=String(e[n]).split(/\s+/).map(function(e){return i(e).toLowerCase().replace(/[^a-z]/g,"")}).filter(Boolean);if(r.length>0){for(var a=r[r.length-1],l="",s=0;s<r.length-1;s++)l+=r[s].charAt(0);if(t=l+a)break}}return t}function i(e){return String(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}Object.defineProperty(t,"__esModule",{value:!0}),t.fromTitle=r,t.fromPersonalName=a},"./pages/role-summary-page.jsx":function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RoleSummaryPageSync=t.RoleSummaryPage=t.default=void 0;var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=n("../../common/node_modules/lodash/lodash.js"),c=a(d),f=n("../../common/node_modules/react/index.js"),m=a(f),p=n("../../common/node_modules/relaks/index.js"),h=n("../../common/src/utils/memoize.js"),g=n("../../common/src/utils/component-refs.js"),v=a(g),y=n("../../common/src/objects/finders/role-finder.js"),b=r(y),k=n("../../common/src/objects/finders/system-finder.js"),C=r(k),E=n("../../common/src/objects/finders/user-finder.js"),j=r(E),w=n("../../common/src/utils/slug-generator.js"),R=r(w),_=n("./widgets/push-button.jsx"),P=a(_),S=n("./widgets/combo-button.jsx"),O=a(S),I=n("./widgets/instruction-block.jsx"),D=a(I),x=n("./widgets/text-field.jsx"),U=a(x),N=n("./widgets/multilingual-text-field.jsx"),T=a(N),L=n("./widgets/option-list.jsx"),F=a(L),z=n("./widgets/input-error.jsx"),A=a(z),M=n("./widgets/action-confirmation.jsx"),B=a(M),W=n("./widgets/data-loss-warning.jsx"),q=a(W),$=n("./widgets/unexpected-error.jsx"),J=a($);n("./pages/role-summary-page.scss");var G=n("../../common/src/data/database.js"),H=(a(G),n("../../common/src/routing/route.js")),K=(a(H),n("../../common/src/env/environment.js")),Q=(a(K),function(e){function t(){return i(this,t),l(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"renderAsync",value:function(e){var t=this.props,n=t.database,r=t.route,a=t.env,i=t.roleID,l=t.editing,s=n.use({schema:"global",by:this}),o="new"===i,u={system:void 0,role:void 0,users:void 0,database:n,route:r,env:a,editing:l||o,creating:o};return e.show(m.default.createElement(V,u)),s.start().then(function(e){return C.findSystem(s).then(function(e){u.system=e})}).then(function(){if(!o)return b.findRole(s,i).then(function(e){u.role=e})}).then(function(){return e.show(m.default.createElement(V,u)),j.findActiveUsers(s).then(function(e){u.users=e})}).then(function(){return m.default.createElement(V,u)})}}]),t}(p.AsyncComponent));Q.displayName="RoleSummaryPage";var V=function(e){function t(e){i(this,t);var n=l(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.handleDisableClick=function(e){var t=n.props.env,r=n.components.confirmation,a=t.locale.t,i=a("role-summary-confirm-disable");return r.ask(i).then(function(e){if(e)return n.changeFlags({disabled:!0}).then(function(e){if(e)return n.returnToList()})})},n.handleDeleteClick=function(e){var t=n.props.env,r=n.components.confirmation,a=t.locale.t,i=a("role-summary-confirm-delete");return r.ask(i).then(function(e){if(e)return n.changeFlags({deleted:!0}).then(function(e){if(e)return n.returnToList()})})},n.handleReactivateClick=function(e){var t=n.props.env,r=n.components.confirmation,a=t.locale.t,i=a("role-summary-confirm-reactivate");return r.ask(i).then(function(e){if(e)return n.changeFlags({disabled:!1,deleted:!1})})},n.handleReturnClick=function(e){return n.returnToList()},n.handleAddClick=function(e){return n.startNew()},n.handleEditClick=function(e){return n.setEditability(!0)},n.handleCancelClick=function(e){return n.setEditability(!1)},n.handleSaveClick=function(e){var t=n.props,r=t.database,a=t.users,i=n.state,l=i.saving,s=i.removingUserIDs,o=i.addingUserIDs;if(!l){var u=n.findProblems();if(c.default.some(u))return void n.setState({problems:u});var d=n.getRole();n.setState({saving:!0,adding:!d.id,problems:{}},function(){var e=r.use({schema:"global",by:n});return e.start().then(function(t){return e.saveOne({table:"role"},d).then(function(t){var n=[];return c.default.each(o,function(e){var r=c.default.find(a,{id:e});n.push({id:r.id,role_ids:c.default.union(r.role_ids,[t.id])})}),c.default.each(s,function(e){var r=c.default.find(a,{id:e});n.push({id:r.id,role_ids:c.default.difference(r.role_ids,[t.id])})}),c.default.isEmpty(n)?t:e.save({table:"user"},n).return(t)}).then(function(e){return n.setState({hasChanges:!1,saving:!1},function(){return n.setEditability(!1,e)}),null})}).catch(function(e){var t=void 0;t=409===e.statusCode?{name:"validation-duplicate-role-name"}:{unexpected:e.message},n.setState({problems:t,saving:!1})})})}},n.handleTitleChange=function(e){n.setRoleProperty("details.title",e.target.value)},n.handleNameChange=function(e){var t=c.default.toLower(e.target.value).replace(/\W+/g,"");n.setRoleProperty("name",t)},n.handleDescriptionChange=function(e){n.setRoleProperty("details.description",e.target.value)},n.handleRatingOptionClick=function(e){var t=e.name,r=Z[t];n.setRoleProperty("settings.rating",r)},n.handleUserOptionClick=function(e){var t=n.props.users,r=n.state,a=r.addingUserIDs,i=r.removingUserIDs,l=r.newRole,s=parseInt(e.name),o=c.default.find(t,{id:s}),u=n.getRoleProperty("id");c.default.includes(o.role_ids,u)?i=c.default.includes(i,o.id)?c.default.without(i,o.id):c.default.concat(i,o.id):a=c.default.includes(a,o.id)?c.default.without(a,o.id):c.default.concat(a,o.id);var d=!0;l||(d=!c.default.isEmpty(a)||!c.default.isEmpty(i)),n.setState({addingUserIDs:a,removingUserIDs:i,hasChanges:d})},n.components=(0,v.default)({confirmation:B.default}),n.state={newRole:null,hasChanges:!1,saving:!1,adding:!1,removingUserIDs:[],addingUserIDs:[],problems:{}},n}return s(t,e),u(t,[{key:"getRole",value:function(e){var t=this.props,n=t.role,r=t.editing,a=this.state.newRole;return!r||e&&"current"!==e?n||Y:a||n||Y}},{key:"getRoleProperty",value:function(e,t){var n=this.getRole(t);return c.default.get(n,e)}},{key:"setRoleProperty",value:function(e,t){var n=this.props.role,r=this.state,a=r.addingUserIDs,i=r.removingUserIDs,l=this.getRole("current"),s=c.default.decoupleSet(l,e,t);if("details.title"===e){var o=R.fromTitle(l.details.title),u=R.fromTitle(s.details.title);l.name&&l.name!==o||(s.name=u)}c.default.size(s.name)>128&&(s.name=s.name.substr(0,128));var d=!0;c.default.isEqual(s,n)&&(s=null,d=!c.default.isEmpty(a)||!c.default.isEmpty(i)),this.setState({newRole:s,hasChanges:d})}},{key:"findProblems",value:function(){var e={};return this.getRole().name||(e.name="validation-required"),e}},{key:"setEditability",value:function(e,t){var n=this.props,r=n.route;if(!n.creating||e||t){var a=c.default.clone(r.params);return a.editing=e||void 0,t&&(a.roleID=t.id),r.replace(r.name,a)}return this.returnToList()}},{key:"returnToList",value:function(){return this.props.route.push("role-list-page")}},{key:"startNew",value:function(){var e=this.props.route,t=c.default.clone(e.params);return t.roleID="new",e.replace(e.name,t)}},{key:"getInputLanguages",value:function(){var e=this.props.system;return c.default.get(e,"settings.input_languages",[])}},{key:"componentWillReceiveProps",value:function(e){var t=this.props.editing;e.editing!==t&&(e.editing?this.setState({newRole:null,hasChanges:!1,addingUserIDs:[],removingUserIDs:[]}):this.setState({problems:{}}))}},{key:"render",value:function(){var e=this.props,t=e.route,n=e.env,r=this.state,a=r.hasChanges,i=r.problems,l=this.components.setters,s=n.locale,o=s.t,u=s.p,d=this.getRole(),f=u(c.default.get(d,"details.title"))||d.name;return m.default.createElement("div",{className:"role-summary-page"},this.renderButtons(),m.default.createElement("h2",null,o("role-summary-$title",f)),m.default.createElement(J.default,null,i.unexpected),this.renderForm(),this.renderInstructions(),m.default.createElement(B.default,{ref:l.confirmation,env:n}),m.default.createElement(q.default,{changes:a,env:n,route:t}))}},{key:"renderButtons",value:function(){var e=this.props,t=e.env,n=e.role,r=e.editing,a=this.state,i=a.hasChanges,l=a.adding,s=t.locale.t;if(r)return m.default.createElement("div",{className:"buttons"},m.default.createElement(P.default,{onClick:this.handleCancelClick},s("role-summary-cancel"))," ",m.default.createElement(P.default,{className:"emphasis",disabled:!i,onClick:this.handleSaveClick},s("role-summary-save")));var o=!n||!n.deleted&&!n.disabled,u=void 0;return u=o?l?"add":"return":"reactivate",m.default.createElement("div",{className:"buttons"},m.default.createElement(O.default,{preselected:u},m.default.createElement("option",{name:"return",onClick:this.handleReturnClick},s("role-summary-return")),m.default.createElement("option",{name:"add",onClick:this.handleAddClick},s("role-summary-add")),m.default.createElement("option",{name:"archive",disabled:!o,separator:!0,onClick:this.handleDisableClick},s("role-summary-disable")),m.default.createElement("option",{name:"delete",disabled:!o,onClick:this.handleDeleteClick},s("role-summary-delete")),m.default.createElement("option",{name:"reactivate",hidden:o,onClick:this.handleReactivateClick},s("role-summary-reactivate")))," ",m.default.createElement(P.default,{className:"emphasis",onClick:this.handleEditClick},s("role-summary-edit")))}},{key:"renderForm",value:function(){return m.default.createElement("div",{className:"form"},this.renderTitleInput(),this.renderNameInput(),this.renderDescriptionInput(),this.renderRatingSelector(),this.renderUserSelector())}},{key:"renderTitleInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a={id:"title",value:this.getRoleProperty("details.title"),availableLanguageCodes:this.getInputLanguages(),onChange:this.handleTitleChange,readOnly:!n,env:t};return m.default.createElement(T.default,a,r("role-summary-title"))}},{key:"renderNameInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=this.state.problems,a=t.locale.t,i={id:"name",value:this.getRoleProperty("name"),readOnly:!n,spellCheck:!1,env:t,onChange:this.handleNameChange};return m.default.createElement(U.default,i,a("role-summary-name"),m.default.createElement(A.default,null,a(r.name)))}},{key:"renderDescriptionInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a={id:"description",value:this.getRoleProperty("details.description"),availableLanguageCodes:this.getInputLanguages(),type:"textarea",readOnly:!n,env:t,onChange:this.handleDescriptionChange};return m.default.createElement(T.default,a,r("role-summary-description"))}},{key:"renderRatingSelector",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a=this.getRoleProperty("settings.rating","current")||0,i=(this.getRoleProperty("settings.rating","original"),c.default.map(Z,function(e,t){return{name:t,selected:a===e,previous:a===e,children:r("role-summary-rating-"+t)}})),l={onOptionClick:this.handleRatingOptionClick,readOnly:!n};return m.default.createElement(F.default,l,m.default.createElement("label",null,r("role-summary-rating")),c.default.map(i,function(e,t){return m.default.createElement("option",o({key:t},e))}))}},{key:"renderUserSelector",value:function(){var e=this.props,t=e.env,n=e.users,r=e.editing,a=this.state,i=a.removingUserIDs,l=a.addingUserIDs,s=t.locale,u=s.t,d=s.p,f=this.getRoleProperty("id");n=X(n,t);var p=c.default.map(n,function(e){var t=c.default.includes(e.role_ids,f),n=void 0;return n=t?!c.default.includes(i,e.id):c.default.includes(l,e.id),{name:String(e.id),selected:n,previous:t,children:d(e.details.name)||d.username}}),h={readOnly:!r,onOptionClick:this.handleUserOptionClick};return m.default.createElement(F.default,h,m.default.createElement("label",null,u("role-summary-users")),c.default.map(p,function(e,t){return m.default.createElement("option",o({key:t},e))}))}},{key:"renderInstructions",value:function(){var e=this.props,t=e.env,n=e.editing,r={folder:"role",topic:"role-summary",hidden:!n,env:t};return m.default.createElement("div",{className:"instructions"},m.default.createElement(D.default,r))}},{key:"changeFlags",value:function(e){var t=this,n=this.props,r=n.database,a=n.role,i=r.use({schema:"global",by:this}),l=c.default.assign({},a,e);return i.saveOne({table:"role"},l).catch(function(e){var n={unexpected:e.message};t.setState({problems:n})})}}]),t}(f.PureComponent);V.displayName="RoleSummaryPageSync";var X=(0,h.memoizeWeak)(null,function(e,t){var n=t.locale.p,r=function(e){return n(e.details.name)||e.username};return c.default.sortBy(e,r)}),Y={details:{}},Z={"very-high":50,high:20,normal:0,low:-20,"very-low":-50};t.default=Q,t.RoleSummaryPage=Q,t.RoleSummaryPageSync=V},"./pages/role-summary-page.scss":function(e,t){}});