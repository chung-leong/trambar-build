webpackJsonp(["page-role-summary"],{"../../common/src/objects/finders/system-finder.js":function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.findSystem=void 0;var a=n("../../common/node_modules/babel-runtime/regenerator/index.js"),s=r(a),l=n("../../common/node_modules/babel-runtime/helpers/asyncToGenerator.js"),i=r(l),o=function(){var e=(0,i.default)(s.default.mark(function e(t){var n;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({schema:"global",table:"system",criteria:{},prefetch:!0});case 2:return n=e.sent,e.abrupt("return",n||{});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),u=n("../../common/node_modules/lodash/lodash.js");r(u);t.findSystem=o},"../../common/src/utils/slug-generator.js":function(e,t,n){"use strict";function r(e){"string"==typeof e&&(e={en:e});var t="";for(var n in e)if(t=String(e[n]),t=s(t).toLowerCase(),t=t.replace(/\s+/g,"-"),t=t.replace(/[^0-9a-z\-]/g,""),/^\-+$/.test(t)&&(t=""),t)break;return t.length>32&&(t=t.substr(0,32)),t}function a(e){"string"==typeof e&&(e={en:e});var t="";for(var n in e){var r=String(e[n]).split(/\s+/).map(function(e){return s(e).toLowerCase().replace(/[^a-z]/g,"")}).filter(Boolean);if(r.length>0){for(var a=r[r.length-1],l="",i=0;i<r.length-1;i++)l+=r[i].charAt(0);if(t=l+a)break}}return t}function s(e){return String(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}Object.defineProperty(t,"__esModule",{value:!0}),t.fromTitle=r,t.fromPersonalName=a},"./pages/role-summary-page.jsx":function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RoleSummaryPageSync=t.RoleSummaryPage=t.default=void 0;var s=n("../../common/node_modules/babel-runtime/helpers/extends.js"),l=a(s),i=n("../../common/node_modules/babel-runtime/core-js/get-iterator.js"),o=a(i),u=n("../../common/node_modules/babel-runtime/regenerator/index.js"),d=a(u),c=n("../../common/node_modules/babel-runtime/helpers/asyncToGenerator.js"),f=a(c),m=n("../../common/node_modules/babel-runtime/core-js/object/get-prototype-of.js"),p=a(m),h=n("../../common/node_modules/babel-runtime/helpers/classCallCheck.js"),v=a(h),g=n("../../common/node_modules/babel-runtime/helpers/createClass.js"),y=a(g),b=n("../../common/node_modules/babel-runtime/helpers/possibleConstructorReturn.js"),k=a(b),x=n("../../common/node_modules/babel-runtime/helpers/inherits.js"),C=a(x),w=n("../../common/node_modules/lodash/lodash.js"),j=a(w),E=n("../../common/node_modules/react/index.js"),_=a(E),R=n("../../common/node_modules/relaks/index.js"),S=n("../../common/src/utils/memoize.js"),I=n("../../common/src/utils/component-refs.js"),P=a(I),D=n("../../common/src/objects/finders/role-finder.js"),O=r(D),U=n("../../common/src/objects/finders/system-finder.js"),N=r(U),T=n("../../common/src/objects/finders/user-finder.js"),L=r(T),F=n("../../common/src/utils/slug-generator.js"),z=r(F),A=n("./widgets/push-button.jsx"),M=a(A),B=n("./widgets/combo-button.jsx"),q=a(B),G=n("./widgets/instruction-block.jsx"),$=a(G),J=n("./widgets/text-field.jsx"),W=a(J),H=n("./widgets/multilingual-text-field.jsx"),K=a(H),Q=n("./widgets/option-list.jsx"),V=a(Q),X=n("./widgets/input-error.jsx"),Y=a(X),Z=n("./widgets/action-confirmation.jsx"),ee=a(Z),te=n("./widgets/data-loss-warning.jsx"),ne=a(te),re=n("./widgets/unexpected-error.jsx"),ae=a(re);n("./pages/role-summary-page.scss");var se=n("../../common/src/data/database.js"),le=(a(se),n("../../common/src/routing/route.js")),ie=(a(le),n("../../common/src/env/environment.js")),oe=(a(ie),function(e){function t(){return(0,v.default)(this,t),(0,k.default)(this,(t.__proto__||(0,p.default)(t)).apply(this,arguments))}return(0,C.default)(t,e),(0,y.default)(t,[{key:"renderAsync",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,f.default)(d.default.mark(function e(t){var n,r,a,s,l,i,o,u,c,f;return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.props,r=n.database,a=n.route,s=n.env,l=n.roleID,i=n.editing,o=r.use({schema:"global",by:this}),u="new"===l,c={database:r,route:a,env:s,editing:i||u,creating:u},t.show(_.default.createElement(ue,c)),e.next=7,o.start();case 7:return f=e.sent,e.next=10,N.findSystem(o);case 10:if(c.system=e.sent,u){e.next=15;break}return e.next=14,O.findRole(o,l);case 14:c.role=e.sent;case 15:return t.show(_.default.createElement(ue,c)),e.next=18,L.findActiveUsers(o);case 18:return c.users=e.sent,e.abrupt("return",_.default.createElement(ue,c));case 20:case"end":return e.stop()}},e,this)}));return e}()}]),t}(R.AsyncComponent));oe.displayName="RoleSummaryPage";var ue=function(e){function t(e){var n=this;(0,v.default)(this,t);var r=(0,k.default)(this,(t.__proto__||(0,p.default)(t)).call(this,e));return r.handleDisableClick=function(){var e=(0,f.default)(d.default.mark(function e(t){var a,s,l,i,o,u;return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.props.env,s=r.components.confirmation,l=a.locale.t,i=l("role-summary-confirm-disable"),e.next=6,s.ask(i);case 6:if(!(o=e.sent)){e.next=13;break}return e.next=10,r.changeFlags({disabled:!0});case 10:if(!(u=e.sent)){e.next=13;break}return e.abrupt("return",r.returnToList());case 13:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleDeleteClick=function(){var e=(0,f.default)(d.default.mark(function e(t){var a,s,l,i,o,u;return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.props.env,s=r.components.confirmation,l=a.locale.t,i=l("role-summary-confirm-delete"),e.next=6,s.ask(i);case 6:if(!(o=e.sent)){e.next=13;break}return e.next=10,r.changeFlags({deleted:!0});case 10:if(!(u=e.sent)){e.next=13;break}return e.abrupt("return",r.returnToList());case 13:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleReactivateClick=function(){var e=(0,f.default)(d.default.mark(function e(t){var a,s,l,i,o;return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.props.env,s=r.components.confirmation,l=a.locale.t,i=l("role-summary-confirm-reactivate"),e.next=6,s.ask(i);case 6:if(!(o=e.sent)){e.next=10;break}return e.next=10,r.changeFlags({disabled:!1,deleted:!1});case 10:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleReturnClick=function(){var e=(0,f.default)(d.default.mark(function e(t){return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.returnToList();case 2:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleAddClick=function(){var e=(0,f.default)(d.default.mark(function e(t){return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.startNew();case 2:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleEditClick=function(){var e=(0,f.default)(d.default.mark(function e(t){return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.setEditability(!0);case 2:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleCancelClick=function(){var e=(0,f.default)(d.default.mark(function e(t){return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.setEditability(!1);case 2:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),r.handleSaveClick=function(e){var t=r.props,a=t.database,s=t.users,l=r.state,i=l.saving,u=l.removingUserIDs,c=l.addingUserIDs;if(!i){var m=r.findProblems();if(j.default.some(m))return void r.setState({problems:m});var p=r.getRole();r.setState({saving:!0,adding:!p.id,problems:{}},(0,f.default)(d.default.mark(function e(){var t,l,i,f,m,h,v,g,y,b,k,x,C,w,E,_,R,S;return d.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.use({schema:"global",by:r}),e.next=4,t.start();case 4:return l=e.sent,e.next=7,t.saveOne({table:"role"},p);case 7:for(i=e.sent,f=[],m=!0,h=!1,v=void 0,e.prev=12,g=(0,o.default)(c);!(m=(y=g.next()).done);m=!0)b=y.value,k=j.default.find(s,{id:b}),f.push({id:k.id,role_ids:j.default.union(k.role_ids,[i.id])});e.next=20;break;case 16:e.prev=16,e.t0=e.catch(12),h=!0,v=e.t0;case 20:e.prev=20,e.prev=21,!m&&g.return&&g.return();case 23:if(e.prev=23,!h){e.next=26;break}throw v;case 26:return e.finish(23);case 27:return e.finish(20);case 28:for(x=!0,C=!1,w=void 0,e.prev=31,E=(0,o.default)(u);!(x=(_=E.next()).done);x=!0)R=_.value,k=j.default.find(s,{id:R}),f.push({id:k.id,role_ids:j.default.difference(k.role_ids,[i.id])});e.next=39;break;case 35:e.prev=35,e.t1=e.catch(31),C=!0,w=e.t1;case 39:e.prev=39,e.prev=40,!x&&E.return&&E.return();case 42:if(e.prev=42,!C){e.next=45;break}throw w;case 45:return e.finish(42);case 46:return e.finish(39);case 47:if(j.default.isEmpty(f)){e.next=50;break}return e.next=50,t.save({table:"user"},f);case 50:r.setState({hasChanges:!1,saving:!1},function(){return r.setEditability(!1,i)}),e.next=58;break;case 53:e.prev=53,e.t2=e.catch(0),S=void 0,S=409===e.t2.statusCode?{name:"validation-duplicate-role-name"}:{unexpected:e.t2.message},r.setState({problems:S,saving:!1});case 58:case"end":return e.stop()}},e,n,[[0,53],[12,16,20,28],[21,,23,27],[31,35,39,47],[40,,42,46]])})))}},r.handleTitleChange=function(e){r.setRoleProperty("details.title",e.target.value)},r.handleNameChange=function(e){var t=j.default.toLower(e.target.value).replace(/[^\w\-]+/g,"");r.setRoleProperty("name",t)},r.handleDescriptionChange=function(e){r.setRoleProperty("details.description",e.target.value)},r.handleRatingOptionClick=function(e){var t=e.name,n=fe[t];r.setRoleProperty("settings.rating",n)},r.handleUserOptionClick=function(e){var t=r.props.users,n=r.state,a=n.addingUserIDs,s=n.removingUserIDs,l=n.newRole,i=parseInt(e.name),o=j.default.find(t,{id:i}),u=r.getRoleProperty("id");j.default.includes(o.role_ids,u)?s=j.default.includes(s,o.id)?j.default.without(s,o.id):j.default.concat(s,o.id):a=j.default.includes(a,o.id)?j.default.without(a,o.id):j.default.concat(a,o.id);var d=!0;l||(d=!j.default.isEmpty(a)||!j.default.isEmpty(s)),r.setState({addingUserIDs:a,removingUserIDs:s,hasChanges:d})},r.components=(0,P.default)({confirmation:ee.default}),r.state={newRole:null,hasChanges:!1,saving:!1,adding:!1,removingUserIDs:[],addingUserIDs:[],problems:{}},r}return(0,C.default)(t,e),(0,y.default)(t,[{key:"getRole",value:function(e){var t=this.props.role,n=this.state.newRole;return e&&"current"!==e?t||ce:n||t||ce}},{key:"getRoleProperty",value:function(e,t){var n=this.getRole(t);return j.default.get(n,e)}},{key:"setRoleProperty",value:function(e,t){var n=this.props.role,r=this.state,a=r.addingUserIDs,s=r.removingUserIDs,l=this.getRole("current"),i=j.default.decoupleSet(l,e,t);if("details.title"===e){var o=z.fromTitle(l.details.title),u=z.fromTitle(i.details.title);l.name&&l.name!==o||(i.name=u)}j.default.size(i.name)>128&&(i.name=i.name.substr(0,128));var d=!0;j.default.isEqual(i,n)&&(i=null,d=!j.default.isEmpty(a)||!j.default.isEmpty(s)),this.setState({newRole:i,hasChanges:d})}},{key:"findProblems",value:function(){var e={};return this.getRole().name||(e.name="validation-required"),e}},{key:"setEditability",value:function(e,t){var n=this.props,r=n.route;if(!n.creating||e||t){var a=j.default.clone(r.params);return a.editing=e||void 0,t&&(a.roleID=t.id),r.replace(r.name,a)}return this.returnToList()}},{key:"returnToList",value:function(){return this.props.route.push("role-list-page")}},{key:"startNew",value:function(){var e=this.props.route,t=j.default.clone(e.params);return t.roleID="new",e.replace(e.name,t)}},{key:"getInputLanguages",value:function(){var e=this.props.system;return j.default.get(e,"settings.input_languages",[])}},{key:"render",value:function(){var e=this.props,t=e.route,n=e.env,r=this.state,a=r.hasChanges,s=r.problems,l=this.components.setters,i=n.locale,o=i.t,u=i.p,d=this.getRole(),c=u(j.default.get(d,"details.title"))||d.name;return _.default.createElement("div",{className:"role-summary-page"},this.renderButtons(),_.default.createElement("h2",null,o("role-summary-$title",c)),_.default.createElement(ae.default,null,s.unexpected),this.renderForm(),this.renderInstructions(),_.default.createElement(ee.default,{ref:l.confirmation,env:n}),_.default.createElement(ne.default,{changes:a,env:n,route:t}))}},{key:"renderButtons",value:function(){var e=this.props,t=e.env,n=e.role,r=e.editing,a=this.state,s=a.hasChanges,l=a.adding,i=t.locale.t;if(r)return _.default.createElement("div",{className:"buttons"},_.default.createElement(M.default,{onClick:this.handleCancelClick},i("role-summary-cancel"))," ",_.default.createElement(M.default,{className:"emphasis",disabled:!s,onClick:this.handleSaveClick},i("role-summary-save")));var o=!n||!n.deleted&&!n.disabled,u=void 0;return u=o?l?"add":"return":"reactivate",_.default.createElement("div",{className:"buttons"},_.default.createElement(q.default,{preselected:u},_.default.createElement("option",{name:"return",onClick:this.handleReturnClick},i("role-summary-return")),_.default.createElement("option",{name:"add",onClick:this.handleAddClick},i("role-summary-add")),_.default.createElement("option",{name:"archive",disabled:!o,separator:!0,onClick:this.handleDisableClick},i("role-summary-disable")),_.default.createElement("option",{name:"delete",disabled:!o,onClick:this.handleDeleteClick},i("role-summary-delete")),_.default.createElement("option",{name:"reactivate",hidden:o,onClick:this.handleReactivateClick},i("role-summary-reactivate")))," ",_.default.createElement(M.default,{className:"emphasis",onClick:this.handleEditClick},i("role-summary-edit")))}},{key:"renderForm",value:function(){return _.default.createElement("div",{className:"form"},this.renderTitleInput(),this.renderNameInput(),this.renderDescriptionInput(),this.renderRatingSelector(),this.renderUserSelector())}},{key:"renderTitleInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a={id:"title",value:this.getRoleProperty("details.title"),availableLanguageCodes:this.getInputLanguages(),onChange:this.handleTitleChange,readOnly:!n,env:t};return _.default.createElement(K.default,a,r("role-summary-title"))}},{key:"renderNameInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=this.state.problems,a=t.locale.t,s={id:"name",value:this.getRoleProperty("name"),readOnly:!n,spellCheck:!1,env:t,onChange:this.handleNameChange};return _.default.createElement(W.default,s,a("role-summary-name"),_.default.createElement(Y.default,null,a(r.name)))}},{key:"renderDescriptionInput",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a={id:"description",value:this.getRoleProperty("details.description"),availableLanguageCodes:this.getInputLanguages(),type:"textarea",readOnly:!n,env:t,onChange:this.handleDescriptionChange};return _.default.createElement(K.default,a,r("role-summary-description"))}},{key:"renderRatingSelector",value:function(){var e=this.props,t=e.env,n=e.editing,r=t.locale.t,a=this.getRoleProperty("settings.rating","current")||0,s=(this.getRoleProperty("settings.rating","original"),j.default.map(fe,function(e,t){return{name:t,selected:a===e,previous:a===e,children:r("role-summary-rating-"+t)}})),i={onOptionClick:this.handleRatingOptionClick,readOnly:!n};return _.default.createElement(V.default,i,_.default.createElement("label",null,r("role-summary-rating")),j.default.map(s,function(e,t){return _.default.createElement("option",(0,l.default)({key:t},e))}))}},{key:"renderUserSelector",value:function(){var e=this.props,t=e.env,n=e.users,r=e.editing,a=this.state,s=a.removingUserIDs,i=a.addingUserIDs,o=t.locale,u=o.t,d=o.p,c=this.getRoleProperty("id");n=de(n,t);var f=j.default.map(n,function(e){var t=j.default.includes(e.role_ids,c),n=void 0;return n=t?!j.default.includes(s,e.id):j.default.includes(i,e.id),{name:String(e.id),selected:n,previous:t,children:d(e.details.name)||d.username}}),m={readOnly:!r,onOptionClick:this.handleUserOptionClick};return _.default.createElement(V.default,m,_.default.createElement("label",null,u("role-summary-users")),j.default.map(f,function(e,t){return _.default.createElement("option",(0,l.default)({key:t},e))}))}},{key:"renderInstructions",value:function(){var e=this.props,t=e.env,n=e.editing,r={folder:"role",topic:"role-summary",hidden:!n,env:t};return _.default.createElement("div",{className:"instructions"},_.default.createElement($.default,r))}},{key:"changeFlags",value:function(e){var t=this,n=this.props,r=n.database,a=n.role,s=r.use({schema:"global",by:this}),l=j.default.assign({},a,e);return s.saveOne({table:"role"},l).catch(function(e){var n={unexpected:e.message};t.setState({problems:n})})}}],[{key:"getDerivedStateFromProps",value:function(e,t){return e.editing?null:{newRole:null,hasChanges:!1,addingUserIDs:[],removingUserIDs:[],problems:{}}}}]),t}(E.PureComponent);ue.displayName="RoleSummaryPageSync";var de=(0,S.memoizeWeak)(null,function(e,t){var n=t.locale.p,r=function(e){return n(e.details.name)||e.username};return j.default.sortBy(e,r)}),ce={details:{}},fe={"very-high":50,high:20,normal:0,low:-20,"very-low":-50};t.default=oe,t.RoleSummaryPage=oe,t.RoleSummaryPageSync=ue},"./pages/role-summary-page.scss":function(e,t){}});