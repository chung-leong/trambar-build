webpackJsonp(["page-role-list"],{"./pages/role-list-page.jsx":function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function l(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RoleListPageSync=t.RoleListPage=t.default=void 0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=n("../../common/node_modules/lodash/lodash.js"),c=l(d),f=n("../../common/node_modules/react/index.js"),m=l(f),p=n("../../common/node_modules/relaks/index.js"),h=n("../../common/src/utils/memoize.js"),v=n("../../common/src/utils/component-refs.js"),b=l(v),g=n("../../common/src/objects/finders/role-finder.js"),y=r(g),E=n("../../common/src/objects/finders/user-finder.js"),j=r(E),w=n("./widgets/push-button.jsx"),_=l(w),k=n("./widgets/combo-button.jsx"),C=l(k),O=n("./widgets/sortable-table.jsx"),R=l(O),T=n("./tooltips/user-tooltip.jsx"),P=l(T),x=n("./tooltips/modified-time-tooltip.jsx"),D=l(x),I=n("./widgets/action-badge.jsx"),S=l(I),L=n("./widgets/action-confirmation.jsx"),N=l(L),M=n("./widgets/data-loss-warning.jsx"),W=l(M),U=n("./widgets/unexpected-error.jsx"),F=l(U);n("./pages/role-list-page.scss");var A=n("../../common/src/data/database.js"),z=(l(A),n("../../common/src/routing/route.js")),H=(l(z),n("../../common/src/env/environment.js")),B=(l(H),function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),u(t,[{key:"renderAsync",value:function(e){var t=this.props,n=t.database,r=t.route,l=t.env,o=t.editing,i=n.use({schema:"global",by:this}),a={roles:void 0,users:void 0,database:n,route:r,env:l,editing:o};return e.show(m.default.createElement($,a)),i.start().then(function(e){return y.findAllRoles(i).then(function(e){a.roles=e})}).then(function(){return e.show(m.default.createElement($,a)),j.findUsersWithRoles(i,a.roles).then(function(e){a.users=e})}).then(function(e){return m.default.createElement($,a)})}}]),t}(p.AsyncComponent));B.displayName="RoleListPage";var $=function(e){function t(e){o(this,t);var n=e.editing,r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.handleSort=function(e){r.setState({sortColumns:e.columns,sortDirections:e.directions})},r.handleAddClick=function(e){return r.props.route.push("role-summary-page",{roleID:"new"})},r.handleEditClick=function(e){r.setEditability(!0)},r.handleCancelClick=function(e){r.setEditability(!1)},r.handleSaveClick=function(e){var t=r.props,n=t.database,l=t.env,o=t.roles,i=r.state,a=i.disablingRoleIDs,s=i.restoringRoleIDs,u=r.components.confirmation,d=l.locale.t,f=[d("role-list-confirm-disable-$count",a.length),d("role-list-confirm-reactivate-$count",s.length)],m=[!!c.default.isEmpty(a)||void 0,!!c.default.isEmpty(s)||void 0];return u.askSeries(f,m).then(function(e){if(e){r.setState({problems:{}});var t=n.use({schema:"global",by:r});return t.start().then(function(e){var n=[];return c.default.each(o,function(e){var t={};if(c.default.includes(a,e.id))t.disabled=!0;else{if(!c.default.includes(s,e.id))return;t.disabled=t.deleted=!1}var r=c.default.assign({},e,t);n.push(r)}),t.save({table:"role"},n).then(function(e){return r.setState({hasChanges:!1},function(){r.setEditability(!1)}),null}).catch(function(e){var t={unexpected:e.message};r.setState({problems:t})})})}})},r.handleRowClick=function(e){var t=r.props,n=(t.database,t.roles),l=r.state,o=l.restoringRoleIDs,i=l.disablingRoleIDs,a=parseInt(e.currentTarget.getAttribute("data-role-id")),s=c.default.find(n,{id:a});s.deleted||s.disabled?o=c.default.includes(o,s.id)?c.default.without(o,s.id):c.default.concat(o,s.id):i=c.default.includes(i,s.id)?c.default.without(i,s.id):c.default.concat(i,s.id);var u=!c.default.isEmpty(o)||!c.default.isEmpty(i);r.setState({restoringRoleIDs:o,disablingRoleIDs:i,hasChanges:u})},r.components=(0,b.default)({confirmation:N.default}),r.state={sortColumns:["name"],sortDirections:["asc"],restoringRoleIDs:[],disablingRoleIDs:[],hasChanges:!1,renderingFullList:n,problems:{}},r}return a(t,e),u(t,[{key:"setEditability",value:function(e){var t=this.props.route,n=c.default.clone(t.params);return n.editing=e||void 0,t.replace(t.name,n)}},{key:"componentWillReceiveProps",value:function(e){var t=this,n=this.props.editing;e.editing!==n&&(e.editing?this.setState({renderingFullList:!0,restoringRoleIDs:[],disablingRoleIDs:[],hasChanges:!1}):setTimeout(function(){t.props.editing||t.setState({renderingFullList:!1,problems:{}})},500))}},{key:"render",value:function(){var e=this.props,t=e.route,n=e.env,r=this.state,l=r.hasChanges,o=r.problems,i=this.components.setters,a=n.locale.t;return m.default.createElement("div",{className:"role-list-page"},this.renderButtons(),m.default.createElement("h2",null,a("role-list-title")),m.default.createElement(F.default,null,o.unexpected),this.renderTable(),m.default.createElement(N.default,{ref:i.confirmation,env:n}),m.default.createElement(W.default,{changes:l,env:n,route:t}))}},{key:"renderButtons",value:function(){var e=this.props,t=e.env,n=e.roles,r=e.editing,l=this.state.hasChanges,o=t.locale.t;if(r)return m.default.createElement("div",{className:"buttons"},m.default.createElement(_.default,{onClick:this.handleCancelClick},o("role-list-cancel"))," ",m.default.createElement(_.default,{className:"emphasis",disabled:!l,onClick:this.handleSaveClick},o("role-list-save")));var i=c.default.isEmpty(n);return m.default.createElement("div",{className:"buttons"},m.default.createElement(C.default,{preselected:"add"},m.default.createElement("option",{name:"add",onClick:this.handleAddClick},o("role-list-add")))," ",m.default.createElement(_.default,{className:"emphasis",disabled:i,onClick:this.handleEditClick},o("role-list-edit")))}},{key:"renderTable",value:function(){var e=this.props.editing,t=this.state,n=t.renderingFullList,r=t.sortColumns,l=t.sortDirections,o={sortColumns:r,sortDirections:l,onSort:this.handleSort};return n&&(o.expandable=!0,o.selectable=!0,o.expanded=e,o.onClick=this.handleRowClick),m.default.createElement(R.default,o,m.default.createElement("thead",null,this.renderHeadings()),m.default.createElement("tbody",null,this.renderRows()))}},{key:"renderHeadings",value:function(){return m.default.createElement("tr",null,this.renderTitleColumn(),this.renderUsersColumn(),this.renderModifiedTimeColumn())}},{key:"renderRows",value:function(){var e=this,t=this.props,n=t.env,r=t.roles,l=t.users,o=this.state,i=o.renderingFullList,a=o.sortColumns,s=o.sortDirections;return i||(r=q(r)),r=J(r,l,n,a,s),c.default.map(r,function(t){return e.renderRow(t)})}},{key:"renderRow",value:function(e){var t=this.props.env,n=this.state,r=n.renderingFullList,l=n.restoringRoleIDs,o=n.disablingRoleIDs,i=t.locale.t,a=[],u=void 0,d=void 0;e.deleted?(a.push("deleted"),d=i("role-list-status-deleted")):e.disabled&&(a.push("disabled"),d=i("role-list-status-disabled")),r&&(e.deleted||e.disabled?c.default.includes(l,e.id)&&a.push("selected"):(a.push("fixed"),c.default.includes(o,e.id)||a.push("selected")),u=this.handleRowClick);var f={className:a.join(" "),"data-role-id":e.id,title:d,onClick:u};return m.default.createElement("tr",s({key:e.id},f),this.renderTitleColumn(e),this.renderUsersColumn(e),this.renderModifiedTimeColumn(e))}},{key:"renderTitleColumn",value:function(e){var t=this.props,n=t.route,r=t.env,l=this.state,o=l.renderingFullList,i=l.restoringRoleIDs,a=l.disablingRoleIDs,s=r.locale,u=s.t,d=s.p;if(e){var f=d(e.details.title)||"-",p=void 0,h=void 0;if(o){var v=void 0,b=void 0;e.deleted||e.disabled?(v=!1,b=c.default.includes(i,e.id)):(v=!0,b=!c.default.includes(a,e.id)),v!==b&&(h=b?m.default.createElement(S.default,{type:"reactivate",env:r}):m.default.createElement(S.default,{type:"disable",env:r}))}else{var g={roleID:e.id};p=n.find("role-summary-page",g)}return m.default.createElement("td",null,m.default.createElement("a",{href:p},f)," ",h)}return m.default.createElement(O.TH,{id:"title"},u("table-heading-title"))}},{key:"renderUsersColumn",value:function(e){var t=this.props,n=t.route,r=t.env,l=t.users,o=r.locale.t;if(!r.isWiderThan("narrow"))return null;if(e){var i={users:G(l,e),route:n,env:r};return m.default.createElement("td",null,m.default.createElement(P.default,i))}return m.default.createElement(O.TH,{id:"users"},o("table-heading-users"))}},{key:"renderModifiedTimeColumn",value:function(e){var t=this.props.env,n=t.locale.t;if(!t.isWiderThan("standard"))return null;if(e){var r={time:e.mtime,env:t};return m.default.createElement("td",null,m.default.createElement(D.default,r))}return m.default.createElement(O.TH,{id:"mtime"},n("table-heading-last-modified"))}}]),t}(f.PureComponent);$.displayName="RoleListPageSync";var q=(0,h.memoizeWeak)(null,function(e){return c.default.filter(e,function(e){return!e.deleted&&!e.disabled})}),J=(0,h.memoizeWeak)(null,function(e,t,n,r,l){var o=n.locale.p;return r=c.default.map(r,function(e){switch(e){case"title":return function(e){return o(e.details.title)};case"users":return function(e){return c.default.size(G(t,e))};default:return e}}),c.default.orderBy(e,r,l)}),G=(0,h.memoizeWeak)(null,function(e,t){return c.default.filter(e,function(e){return c.default.includes(e.role_ids,t.id)})});t.default=B,t.RoleListPage=B,t.RoleListPageSync=$},"./pages/role-list-page.scss":function(e,t){},"./tooltips/modified-time-tooltip.jsx":function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ModifiedTimeTooltip=t.default=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n("../../common/node_modules/lodash/lodash.js"),u=r(s),d=n("../../common/node_modules/react/index.js"),c=r(d),f=n("../../common/node_modules/moment/moment.js"),m=r(f),p=n("../../common/src/env/environment.js"),h=(r(p),n("./widgets/tooltip.jsx")),v=r(h),b=function(e){function t(){return l(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),a(t,[{key:"componentWillMount",value:function(){this.updateLabels()}},{key:"componentWillReceiveProps",value:function(e){this.updateLabels(e)}},{key:"updateLabels",value:function(e){var t=e||this.props,n=t.env,r=t.time,l=n.locale.localeCode,o=void 0;r&&(o=(0,m.default)(r),o.locale(l));var i={relativeTime:o?o.fromNow():null,absoluteTime:o?o.format("lll"):null};u.default.isEqual(i,this.state)||this.setState(i)}},{key:"render",value:function(){var e=this.props.disabled,t=this.state,n=t.relativeTime,r=t.absoluteTime;return c.default.createElement(v.default,{disabled:e},c.default.createElement("inline",null,n),c.default.createElement("window",null,r))}},{key:"componentDidMount",value:function(){g.push(this)}},{key:"componentWillUnmount",value:function(){u.default.pull(g,this)}}]),t}(d.PureComponent);b.displayName="ModifiedTimeTooltip";var g=[];setInterval(function(){u.default.each(g,function(e){e.updateLabels()})},3e4),t.default=b,t.ModifiedTimeTooltip=b},"./tooltips/user-tooltip.jsx":function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.UserTooltip=t.default=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n("../../common/node_modules/lodash/lodash.js"),u=r(s),d=n("../../common/node_modules/react/index.js"),c=r(d),f=n("./widgets/tooltip.jsx"),m=r(f),p=n("./widgets/profile-image.jsx"),h=r(p);n("./tooltips/user-tooltip.scss");var v=n("../../common/src/routing/route.js"),b=(r(v),n("../../common/src/env/environment.js")),g=(r(b),function(e){function t(){return l(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),a(t,[{key:"render",value:function(){var e=this.props,t=e.route,n=e.env,r=e.users,l=e.project,o=e.disabled,i=n.locale.t;if(!r)return null;var a=i("user-tooltip-$count",r.length),s=void 0;r.length>10&&(r=u.default.slice(r,0,10),s=c.default.createElement("div",{className:"ellipsis"},c.default.createElement("i",{className:"fa fa-ellipsis-v"})));var d=u.default.map(r,function(e,r){var o=void 0;return o=l?t.find("member-summary-page",{projectID:l.id,userID:e.id}):t.find("user-summary-page",{userID:e.id}),c.default.createElement("div",{className:"item",key:r},c.default.createElement("a",{href:o},c.default.createElement(h.default,{user:e,env:n})," ",e.details.name))}),f=void 0;return f=l?t.find("member-list-page",{projectID:l.id}):t.find("user-list-page"),c.default.createElement(m.default,{className:"user",disabled:o||0===d.length},c.default.createElement("inline",null,a),c.default.createElement("window",null,d,s,c.default.createElement("div",{className:"bottom"},c.default.createElement("a",{href:f},i("tooltip-more")))))}}]),t}(d.PureComponent));g.displayName="UserTooltip",t.default=g,t.UserTooltip=g},"./tooltips/user-tooltip.scss":function(e,t){}});