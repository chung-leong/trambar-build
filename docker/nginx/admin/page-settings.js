webpackJsonp(["page-settings"],{"../../common/src/objects/finders/system-finder.js":function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.findSystem=void 0;var a=n("../../common/node_modules/babel-runtime/regenerator/index.js"),r=s(a),l=n("../../common/node_modules/babel-runtime/helpers/asyncToGenerator.js"),i=s(l),u=function(){var e=(0,i.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({schema:"global",table:"system",criteria:{},prefetch:!0});case 2:return n=e.sent,e.abrupt("return",n||{});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),o=n("../../common/node_modules/lodash/lodash.js");s(o);t.findSystem=u},"../../common/src/objects/settings/system-settings.js":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=void 0;t.SystemSettingsTypedef=s},"./pages/settings-page.jsx":function(e,t,n){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsPageSync=t.SettingsPage=t.default=void 0;var r=n("../../common/node_modules/babel-runtime/helpers/extends.js"),l=a(r),i=n("../../common/node_modules/babel-runtime/regenerator/index.js"),u=a(i),o=n("../../common/node_modules/babel-runtime/helpers/asyncToGenerator.js"),d=a(o),c=n("../../common/node_modules/babel-runtime/core-js/object/get-prototype-of.js"),m=a(c),p=n("../../common/node_modules/babel-runtime/helpers/classCallCheck.js"),g=a(p),f=n("../../common/node_modules/babel-runtime/helpers/createClass.js"),h=a(f),y=n("../../common/node_modules/babel-runtime/helpers/possibleConstructorReturn.js"),v=a(y),b=n("../../common/node_modules/babel-runtime/helpers/inherits.js"),S=a(b),k=n("../../common/node_modules/lodash/lodash.js"),C=a(k),_=n("../../common/node_modules/react/index.js"),j=a(_),E=n("../../common/node_modules/relaks/index.js"),P=n("../../common/src/objects/finders/system-finder.js"),w=s(P),x=n("../../common/src/objects/settings/system-settings.js"),I=s(x),O=n("./widgets/push-button.jsx"),N=a(O),L=n("./widgets/instruction-block.jsx"),T=a(L),A=n("./widgets/text-field.jsx"),B=a(A),D=n("./widgets/multilingual-text-field.jsx"),M=a(D),R=n("./widgets/option-list.jsx"),F=a(R),G=n("./widgets/image-selector.jsx"),q=a(G),z=n("./widgets/data-loss-warning.jsx"),J=a(z),H=n("./widgets/unexpected-error.jsx"),K=a(H);n("./pages/settings-page.scss");var Q=n("../../common/src/data/database.js"),U=(a(Q),n("../../common/src/routing/route.js")),V=(a(U),n("../../common/src/env/environment.js")),W=(a(V),n("../../common/src/transport/payloads.js")),X=(a(W),function(e){function t(){return(0,g.default)(this,t),(0,v.default)(this,(t.__proto__||(0,m.default)(t)).apply(this,arguments))}return(0,S.default)(t,e),(0,h.default)(t,[{key:"renderAsync",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,d.default)(u.default.mark(function e(t){var n,s,a,r,l,i,o,d,c;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.props,s=n.database,a=n.route,r=n.env,l=n.payloads,i=n.editing,o=s.use({schema:"global",by:this}),d={database:s,route:a,env:r,payloads:l,editing:i},t.show(j.default.createElement(Y,d)),e.next=6,o.start();case 6:return c=e.sent,e.next=9,w.findSystem(o);case 9:return d.system=e.sent,C.default.isEmpty(d.system)&&(d.system=null),e.abrupt("return",j.default.createElement(Y,d));case 12:case"end":return e.stop()}},e,this)}));return e}()}]),t}(E.AsyncComponent));X.displayName="SettingsPage";var Y=function(e){function t(e){var n=this;(0,g.default)(this,t);var s=(0,v.default)(this,(t.__proto__||(0,m.default)(t)).call(this,e));return s.handleEditClick=function(e){return s.setEditability(!0)},s.handleCancelClick=function(e){return s.setEditability(!1)},s.handleSaveClick=function(){var e=(0,d.default)(u.default.mark(function e(t){var a,r,l,i;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=s.props,r=a.database,l=a.payloads,!(i=s.state.saving)){e.next=4;break}return e.abrupt("return");case 4:s.setState({saving:!0},(0,d.default)(u.default.mark(function e(){var t,a,i,o,d,c;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t="global",a=r.use({schema:t,by:s}),i=s.getSystem(),e.next=6,a.start();case 6:return o=e.sent,e.next=9,a.saveOne({table:"system"},i);case 9:d=e.sent,l.dispatch(d),s.setState({hasChanges:!1,saving:!1,problems:{}},function(){s.setEditability(!1)}),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(0),c={unexpected:e.t0.message},s.setState({problems:c,saving:!1});case 18:case"end":return e.stop()}},e,n,[[0,14]])})));case 5:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),s.handleTitleChange=function(e){s.setSystemProperty("details.title",e.target.value)},s.handleCompanyNameChange=function(e){s.setSystemProperty("details.company_name",e.target.value)},s.handleAddressChange=function(e){s.setSystemProperty("settings.address",e.target.value)},s.handlePushRelayChange=function(e){s.setSystemProperty("settings.push_relay",e.target.value)},s.handleDescriptionChange=function(e){s.setSystemProperty("details.description",e.target.value)},s.handleBackgroundImageChange=function(e){s.setSystemProperty("details.resources",e.target.value)},s.handleLanguageOptionClick=function(e){var t=s.getSystem(),n=C.default.get(t,"settings.input_languages",[]),a=e.name;n=C.default.includes(n,a)?C.default.without(n,a):C.default.concat(n,a),s.setSystemProperty("settings.input_languages",n)},s.state={newSystem:null,saving:!1,problems:{}},s}return(0,S.default)(t,e),(0,h.default)(t,[{key:"getSystem",value:function(e){var t=this.props,n=t.system,s=t.editing,a=this.state.newSystem;return!s||e&&"current"!==e?n||te:a||n||ee}},{key:"getSystemProperty",value:function(e,t){var n=this.getSystem(t);return C.default.get(n,e)}},{key:"setSystemProperty",value:function(e,t){var n=this.props.system,s=this.getSystem("current"),a=C.default.decoupleSet(s,e,t),r=!0;C.default.isEqual(a,n)&&(a=null,r=!1),this.setState({newSystem:a,hasChanges:r})}},{key:"setEditability",value:function(e){var t=this.props.route,n=C.default.clone(t.params);return n.editing=e||void 0,t.replace(t.name,n)}},{key:"getInputLanguages",value:function(){var e=this.getSystem();return C.default.get(e,"settings.input_languages",[])}},{key:"render",value:function(){var e=this.props.env,t=this.state.problems,n=e.locale.t;return j.default.createElement("div",{className:"settings-page"},this.renderButtons(),j.default.createElement("h2",null,n("settings-title")),j.default.createElement(K.default,null,t.unexpected),this.renderForm(),this.renderInstructions())}},{key:"renderButtons",value:function(){var e=this.props,t=e.route,n=e.env,s=e.editing,a=this.state.hasChanges,r=n.locale.t;return s?j.default.createElement("div",{key:"edit",className:"buttons"},j.default.createElement(N.default,{onClick:this.handleCancelClick},r("settings-cancel"))," ",j.default.createElement(N.default,{className:"emphasis",disabled:!a,onClick:this.handleSaveClick},r("settings-save")),j.default.createElement(J.default,{changes:a,env:n,route:t})):j.default.createElement("div",{key:"view",className:"buttons"},j.default.createElement(N.default,{className:"emphasis",onClick:this.handleEditClick},r("settings-edit")))}},{key:"renderForm",value:function(){return j.default.createElement("div",{className:"form"},this.renderTitleInput(),this.renderCompanyNameInput(),this.renderDescriptionInput(),this.renderSiteAddressInput(),this.renderPushRelayInput(),this.renderBackgroundSelector(),this.renderInputLanguageSelector())}},{key:"renderTitleInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"title",value:this.getSystemProperty("details.title"),availableLanguageCodes:this.getInputLanguages(),readOnly:!n,env:t,onChange:this.handleTitleChange};return j.default.createElement(M.default,a,s("settings-site-title"))}},{key:"renderCompanyNameInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"company_name",value:this.getSystemProperty("details.company_name"),readOnly:!n,env:t,onChange:this.handleCompanyNameChange};return j.default.createElement(B.default,a,s("settings-company-name"))}},{key:"renderDescriptionInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"description",value:this.getSystemProperty("details.description"),availableLanguageCodes:this.getInputLanguages(),type:"textarea",readOnly:!n,env:t,onChange:this.handleDescriptionChange};return j.default.createElement(M.default,a,s("settings-site-description"))}},{key:"renderSiteAddressInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"address",type:"url",value:this.getSystemProperty("settings.address"),placeholder:"https://",readOnly:!n,spellCheck:!1,env:t,onChange:this.handleAddressChange};return j.default.createElement(B.default,a,s("settings-site-address"))}},{key:"renderPushRelayInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"relay",type:"url",value:this.getSystemProperty("settings.push_relay"),placeholder:"https://",readOnly:!n,spellCheck:!1,env:t,onChange:this.handlePushRelayChange};return j.default.createElement(B.default,a,s("settings-push-relay"))}},{key:"renderBackgroundSelector",value:function(){var e=this.props,t=e.database,n=e.env,s=e.payloads,a=e.editing,r=n.locale.t,l={purpose:"background",resources:this.getSystemProperty("details.resources"),readOnly:!a,database:t,payloads:s,env:n,onChange:this.handleBackgroundImageChange};return j.default.createElement(q.default,l,r("settings-background-image"))}},{key:"renderInputLanguageSelector",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale,a=s.t,r=s.directory,i=this.getSystemProperty("settings.input_languages","current")||[],u=this.getSystemProperty("settings.input_languages","original")||[],o=C.default.map(r,function(e){var t=C.default.indexOf(i,e.code),n=void 0;return-1!==t&&(n=j.default.createElement("span",{className:"language-badge"},t+1)),{name:e.code,selected:C.default.includes(i,e.code),previous:C.default.includes(u,e.code),children:j.default.createElement("span",null,e.name," ",n)}}),d={readOnly:!n,onOptionClick:this.handleLanguageOptionClick};return j.default.createElement(F.default,d,j.default.createElement("label",null,a("settings-input-languages")),C.default.map(o,function(e,t){return j.default.createElement("option",(0,l.default)({key:t},e))}))}},{key:"renderInstructions",value:function(){var e=this.props,t=e.env,n=e.editing,s={folder:"settings",topic:"settings",hidden:!n,env:t};return j.default.createElement("div",{className:"instructions"},j.default.createElement(T.default,s))}}],[{key:"getDerivedStateFromProps",value:function(e,t){return e.editing?null:{newSystem:null,hasChanges:!1,problems:{}}}}]),t}(_.PureComponent);Y.displayName="SettingsPageSync";var Z=void 0,$=(new Date).getTimezoneOffset()/60;Z=-5<=$&&$<=0?"https://eu-west-1.push.trambar.io":"https://us-east-1.push.trambar.io";var ee={details:{},settings:{address:window.location.protocol+"//"+window.location.host,push_relay:Z}},te={details:{},settings:I.default};t.default=X,t.SettingsPage=X,t.SettingsPageSync=Y},"./pages/settings-page.scss":function(e,t){}});