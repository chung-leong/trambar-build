webpackJsonp(["page-settings"],{"../../common/src/objects/finders/system-finder.js":function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function a(e){return e.findOne({schema:"global",table:"system",criteria:{},prefetch:!0}).then(function(e){return e||{}})}Object.defineProperty(t,"__esModule",{value:!0}),t.findSystem=void 0;var r=n("../../common/node_modules/lodash/lodash.js"),i=(s(r),n("../../common/node_modules/bluebird/js/browser/bluebird.js"));s(i);t.findSystem=a},"../../common/src/objects/settings/system-settings.js":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=void 0;t.SystemSettingsTypedef=s},"./pages/settings-page.jsx":function(e,t,n){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsPageSync=t.SettingsPage=t.default=void 0;var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),d=n("../../common/node_modules/lodash/lodash.js"),c=a(d),g=n("../../common/node_modules/react/index.js"),p=a(g),f=n("../../common/node_modules/relaks/index.js"),h=n("../../common/src/objects/finders/system-finder.js"),m=s(h),y=n("../../common/src/objects/settings/system-settings.js"),v=s(y),b=n("./widgets/push-button.jsx"),S=a(b),C=n("./widgets/instruction-block.jsx"),k=a(C),j=n("./widgets/text-field.jsx"),_=a(j),P=n("./widgets/multilingual-text-field.jsx"),E=a(P),w=n("./widgets/option-list.jsx"),O=a(w),x=n("./widgets/image-selector.jsx"),I=a(x),N=n("./widgets/data-loss-warning.jsx"),L=a(N),T=n("./widgets/unexpected-error.jsx"),A=a(T);n("./pages/settings-page.scss");var B=n("../../common/src/data/database.js"),M=(a(B),n("../../common/src/routing/route.js")),R=(a(M),n("../../common/src/env/environment.js")),D=(a(R),n("../../common/src/transport/payloads.js")),F=(a(D),function(e){function t(){return r(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return l(t,e),u(t,[{key:"renderAsync",value:function(e){var t=this.props,n=t.database,s=t.route,a=t.env,r=t.payloads,i=t.editing,l=n.use({schema:"global",by:this}),o={system:void 0,database:n,route:s,env:a,payloads:r,editing:i};return e.show(p.default.createElement(q,o)),l.start().then(function(e){return m.findSystem(l).then(function(e){o.system=c.default.isEmpty(e)?null:e})}).then(function(){return p.default.createElement(q,o)})}}]),t}(f.AsyncComponent));F.displayName="SettingsPage";var q=function(e){function t(e){r(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.handleEditClick=function(e){return n.setEditability(!0)},n.handleCancelClick=function(e){return n.setEditability(!1)},n.handleSaveClick=function(e){var t=n.props,s=t.database,a=t.payloads;n.state.saving||n.setState({saving:!0},function(){var e=s.use({schema:"global",by:n}),t=n.getSystem();return e.start().then(function(s){return e.saveOne({table:"system"},t).then(function(e){return a.dispatch(e),n.setState({hasChanges:!1,saving:!1,problems:{}},function(){n.setEditability(!1)}),null})}).catch(function(e){var t={unexpected:e.message};n.setState({problems:t,saving:!1})})})},n.handleTitleChange=function(e){n.setSystemProperty("details.title",e.target.value)},n.handleCompanyNameChange=function(e){n.setSystemProperty("details.company_name",e.target.value)},n.handleAddressChange=function(e){n.setSystemProperty("settings.address",e.target.value)},n.handlePushRelayChange=function(e){n.setSystemProperty("settings.push_relay",e.target.value)},n.handleDescriptionChange=function(e){n.setSystemProperty("details.description",e.target.value)},n.handleBackgroundImageChange=function(e){n.setSystemProperty("details.resources",e.target.value)},n.handleLanguageOptionClick=function(e){var t=n.getSystem(),s=c.default.get(t,"settings.input_languages",[]),a=e.name;s=c.default.includes(s,a)?c.default.without(s,a):c.default.concat(s,a),n.setSystemProperty("settings.input_languages",s)},n.state={newSystem:null,saving:!1,problems:{}},n}return l(t,e),u(t,[{key:"getSystem",value:function(e){var t=this.props,n=t.system,s=t.editing,a=this.state.newSystem;return!s||e&&"current"!==e?n||G:a||n||W}},{key:"getSystemProperty",value:function(e,t){var n=this.getSystem(t);return c.default.get(n,e)}},{key:"setSystemProperty",value:function(e,t){var n=this.props.system,s=this.getSystem("current"),a=c.default.decoupleSet(s,e,t),r=!0;c.default.isEqual(a,n)&&(a=null,r=!1),this.setState({newSystem:a,hasChanges:r})}},{key:"setEditability",value:function(e){var t=this.props.route,n=c.default.clone(t.params);return n.editing=e||void 0,t.replace(t.name,n)}},{key:"getInputLanguages",value:function(){var e=this.getSystem();return c.default.get(e,"settings.input_languages",[])}},{key:"componentWillReceiveProps",value:function(e){var t=this.props.editing;e.editing!==t&&(e.editing?this.setState({newSystem:null,hasChanges:!1}):this.setState({problems:{}}))}},{key:"render",value:function(){var e=this.props.env,t=this.state.problems,n=e.locale.t;return p.default.createElement("div",{className:"settings-page"},this.renderButtons(),p.default.createElement("h2",null,n("settings-title")),p.default.createElement(A.default,null,t.unexpected),this.renderForm(),this.renderInstructions())}},{key:"renderButtons",value:function(){var e=this.props,t=e.route,n=e.env,s=e.editing,a=this.state.hasChanges,r=n.locale.t;return s?p.default.createElement("div",{key:"edit",className:"buttons"},p.default.createElement(S.default,{onClick:this.handleCancelClick},r("settings-cancel"))," ",p.default.createElement(S.default,{className:"emphasis",disabled:!a,onClick:this.handleSaveClick},r("settings-save")),p.default.createElement(L.default,{changes:a,env:n,route:t})):p.default.createElement("div",{key:"view",className:"buttons"},p.default.createElement(S.default,{className:"emphasis",onClick:this.handleEditClick},r("settings-edit")))}},{key:"renderForm",value:function(){return p.default.createElement("div",{className:"form"},this.renderTitleInput(),this.renderCompanyNameInput(),this.renderDescriptionInput(),this.renderSiteAddressInput(),this.renderPushRelayInput(),this.renderBackgroundSelector(),this.renderInputLanguageSelector())}},{key:"renderTitleInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"title",value:this.getSystemProperty("details.title"),availableLanguageCodes:this.getInputLanguages(),readOnly:!n,env:t,onChange:this.handleTitleChange};return p.default.createElement(E.default,a,s("settings-site-title"))}},{key:"renderCompanyNameInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"company_name",value:this.getSystemProperty("details.company_name"),readOnly:!n,env:t,onChange:this.handleCompanyNameChange};return p.default.createElement(_.default,a,s("settings-company-name"))}},{key:"renderDescriptionInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"description",value:this.getSystemProperty("details.description"),availableLanguageCodes:this.getInputLanguages(),type:"textarea",readOnly:!n,env:t,onChange:this.handleDescriptionChange};return p.default.createElement(E.default,a,s("settings-site-description"))}},{key:"renderSiteAddressInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"address",type:"url",value:this.getSystemProperty("settings.address"),placeholder:"https://",readOnly:!n,spellCheck:!1,env:t,onChange:this.handleAddressChange};return p.default.createElement(_.default,a,s("settings-site-address"))}},{key:"renderPushRelayInput",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale.t,a={id:"relay",type:"url",value:this.getSystemProperty("settings.push_relay"),placeholder:"https://",readOnly:!n,spellCheck:!1,env:t,onChange:this.handlePushRelayChange};return p.default.createElement(_.default,a,s("settings-push-relay"))}},{key:"renderBackgroundSelector",value:function(){var e=this.props,t=e.database,n=e.env,s=e.payloads,a=e.editing,r=n.locale.t,i={purpose:"background",resources:this.getSystemProperty("details.resources"),readOnly:!a,database:t,payloads:s,env:n,onChange:this.handleBackgroundImageChange};return p.default.createElement(I.default,i,r("settings-background-image"))}},{key:"renderInputLanguageSelector",value:function(){var e=this.props,t=e.env,n=e.editing,s=t.locale,a=s.t,r=s.directory,i=this.getSystemProperty("settings.input_languages","current")||[],l=this.getSystemProperty("settings.input_languages","original")||[],u=c.default.map(r,function(e){var t=c.default.indexOf(i,e.code),n=void 0;return-1!==t&&(n=p.default.createElement("span",{className:"language-badge"},t+1)),{name:e.code,selected:c.default.includes(i,e.code),previous:c.default.includes(l,e.code),children:p.default.createElement("span",null,e.name," ",n)}}),d={readOnly:!n,onOptionClick:this.handleLanguageOptionClick};return p.default.createElement(O.default,d,p.default.createElement("label",null,a("settings-input-languages")),c.default.map(u,function(e,t){return p.default.createElement("option",o({key:t},e))}))}},{key:"renderInstructions",value:function(){var e=this.props,t=e.env,n=e.editing,s={folder:"settings",topic:"settings",hidden:!n,env:t};return p.default.createElement("div",{className:"instructions"},p.default.createElement(k.default,s))}}]),t}(g.PureComponent);q.displayName="SettingsPageSync";var z=void 0,J=(new Date).getTimezoneOffset()/60;z=-5<=J&&J<=0?"https://eu-west-1.push.trambar.io":"https://us-east-1.push.trambar.io";var W={details:{},settings:{address:window.location.protocol+"//"+window.location.host,push_relay:z}},G={details:{},settings:v.default};t.default=F,t.SettingsPage=F,t.SettingsPageSync=q},"./pages/settings-page.scss":function(e,t){}});